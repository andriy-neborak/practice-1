import serial
import time


def crc8(data):
    crc = 0
    for byte in data:
        crc ^= byte
        for _ in range(8):
            if crc & 0x80:
                crc = ((crc << 1) ^ 0x07) & 0xFF
            else:
                crc = (crc << 1) & 0xFF
    return crc


ser = serial.serial_for_url('loop://', timeout=0.1)


command = 0x10
address1 = 0x01
address2 = 0x02
data1 = 0x05
data2 = 0x06

packet = bytes([command, address1, address2, data1, data2])

calculated_crc = crc8(packet)

print("Data bytes:     ", list(packet))
print("Calculated CRC: ", calculated_crc)

full_packet = packet + bytes([calculated_crc])

print("Full packet:    ", list(full_packet))

ser.write(full_packet)


time.sleep(0.05)
received = ser.read(6)

print("\nReceived packet:", list(received))


if len(received) == 6:
    received_data = received[:-1]
    received_crc = received[-1]

    recalculated_crc = crc8(received_data)

    print("CRC received:   ", received_crc)
    print("CRC calculated: ", recalculated_crc)

    if received_crc == recalculated_crc:
        print("CRC OK")
    else:
        print("CRC ERROR")
else:
    print("Timeout or incomplete packet")
